{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>카드 자세히 보기</title>
    <link rel="stylesheet" href="{% static 'my_app/css/mypage/card_detail.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        .markdown-content pre {
            background-color: #f6f8fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .markdown-content code {
            font-family: 'D2Coding', 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <header>{{ card.title }}</header>

    <main>
        <div class="chat-container">
            <ul class="chat-messages">
                {% for message in messages %}
                    <li class="chat-message">
                        {# |linebreaksbr 필터를 제거하여 순수한 마크다운 텍스트를 전달 #}
                        <div class="markdown-content">{{ message.content }}</div>
                        {% if message.images.all %}
                            <div class="message-images">
                                {% for image in message.images.all %}
                                    <img src="{{ image.image_url }}" alt="첨부 이미지" class="message-image">
                                {% endfor %}
                            </div>
                        {% endif %}
                    </li>
                {% empty %}
                    <li class="no-messages">저장된 메시지가 없습니다.</li>
                {% endfor %}
            </ul>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            document.querySelectorAll('.markdown-content').forEach(elem => {
                // Django가 전달한 순수 텍스트를 파싱하여 HTML로 변환
                elem.innerHTML = marked.parse(elem.textContent);
            });

            // 변환된 HTML 내의 코드 블록에 하이라이팅을 적용
            hljs.highlightAll();
        });
    </script>
</body>
</html>